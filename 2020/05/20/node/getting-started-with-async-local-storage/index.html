<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Introduction Node.js version 14, shipped with some interesting experimental additions to the core API, among which was the async local storage API . This API provides a native implementation of web re">
<meta property="og:type" content="article">
<meta property="og:title" content="Getting Started With Async Local Storage API in Node.js">
<meta property="og:url" content="https://allanmogusu.tk/2020/05/20/node/getting-started-with-async-local-storage/index.html">
<meta property="og:site_name" content="Allan Mogusu">
<meta property="og:description" content="Introduction Node.js version 14, shipped with some interesting experimental additions to the core API, among which was the async local storage API . This API provides a native implementation of web re">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://allanmogusu.tk/images/getting-started-with-async-local-storage/screenshot01.png">
<meta property="article:published_time" content="2020-05-20T05:15:00.000Z">
<meta property="article:modified_time" content="2020-05-20T20:21:04.076Z">
<meta property="article:author" content="Allan Mogusu">
<meta property="article:tag" content="node js">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://allanmogusu.tk/images/getting-started-with-async-local-storage/screenshot01.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Getting Started With Async Local Storage API in Node.js</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.1"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/allan690" target="_blank" rel="noopener">Projects</a></li>
         
          <li><a href="/contact/">Contact</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2020/06/11/devops/deploying-flask-app-to-k8s-aws-part-1/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2020/05/08/stackabuse/2020/unit-testing-node-app-with-jest/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://allanmogusu.tk/2020/05/20/node/getting-started-with-async-local-storage/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://allanmogusu.tk/2020/05/20/node/getting-started-with-async-local-storage/&text=Getting Started With Async Local Storage API in Node.js" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://allanmogusu.tk/2020/05/20/node/getting-started-with-async-local-storage/&title=Getting Started With Async Local Storage API in Node.js" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://allanmogusu.tk/2020/05/20/node/getting-started-with-async-local-storage/&is_video=false&description=Getting Started With Async Local Storage API in Node.js" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Getting Started With Async Local Storage API in Node.js&body=Check out this article: https://allanmogusu.tk/2020/05/20/node/getting-started-with-async-local-storage/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://allanmogusu.tk/2020/05/20/node/getting-started-with-async-local-storage/&title=Getting Started With Async Local Storage API in Node.js" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://allanmogusu.tk/2020/05/20/node/getting-started-with-async-local-storage/&title=Getting Started With Async Local Storage API in Node.js" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://allanmogusu.tk/2020/05/20/node/getting-started-with-async-local-storage/&title=Getting Started With Async Local Storage API in Node.js" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://allanmogusu.tk/2020/05/20/node/getting-started-with-async-local-storage/&title=Getting Started With Async Local Storage API in Node.js" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://allanmogusu.tk/2020/05/20/node/getting-started-with-async-local-storage/&name=Getting Started With Async Local Storage API in Node.js&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://allanmogusu.tk/2020/05/20/node/getting-started-with-async-local-storage/&t=Getting Started With Async Local Storage API in Node.js" target="_blank" rel="noopener"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Getting-Started"><span class="toc-number">2.</span> <span class="toc-text">Getting Started</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">3.</span> <span class="toc-text">Conclusion</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Getting Started With Async Local Storage API in Node.js
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Allan Mogusu</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-05-20T05:15:00.000Z" itemprop="datePublished">2020-05-20</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/web/">web</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/node-js/" rel="tag">node js</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p> <a rel="nofollow noopener" target="_blank" href="https://nodejs.org/api/documentation.html">Node.js version 14</a>, shipped with some interesting experimental additions to the core API, among which was the <a rel="nofollow noopener" target="_blank" href="https://nodejs.org/api/async_hooks.html#async_hooks_class_asynclocalstorage">async local storage API </a>. This API provides a native implementation of web request handling akin to <a rel="nofollow noopener" target="_blank" href="https://www.c-sharpcorner.com/UploadFile/1d42da/working-with-thread-local-storagetls-in-C-Sharp/">thread-local storage </a> in multi-threaded languages. Before the addition of this API, users who wanted to leverage this capability in Node.js, mostly turned to the <a rel="nofollow noopener" target="_blank" href="https://github.com/Jeff-Lewis/cls-hooked">cls-hooked library </a>, which beneath the hood is implemented using <a rel="nofollow noopener" target="_blank" href="https://nodejs.org/api/async_hooks.html#async_hooks_async_hooks">async hooks </a>.</p>
<p>I actually came across the async local storage API while reading up the official documentation on async hooks -  a module in Node.js that provides an API to track async resources in a Node application. Async resources inherit from the async wrap class and are simply objects with an associated callback.</p>
<h2 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h2><p>So when can you use the async local storage API, and what benefits does it provide?</p>
<p>Generally, if you are setting a property on the <code>request</code> or <code>response</code> handlers of a HTTP request, you can use async local storage. Also, if you want to persist some information during the lifetime of a request, this API comes in handy.</p>
<p>Letâ€™s now write some code to illustrate this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> axios = <span class="built_in">require</span>(<span class="string">'axios'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; AsyncLocalStorage &#125; = <span class="built_in">require</span>(<span class="string">'async_hooks'</span>);</span><br><span class="line"><span class="keyword">const</span> uuid = <span class="built_in">require</span>(<span class="string">'uuid/v4'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> asyncLocalStorage = <span class="keyword">new</span> AsyncLocalStorage();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> requestMiddleware = <span class="keyword">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> asyncLocalStorage.run(<span class="keyword">new</span> <span class="built_in">Map</span>(), () =&gt; &#123;</span><br><span class="line">        asyncLocalStorage.getStore().set(<span class="string">'reqId'</span>, uuid());</span><br><span class="line">        next();</span><br><span class="line">      &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(requestMiddleware);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/test'</span>, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> store = asyncLocalStorage.getStore();</span><br><span class="line">    <span class="keyword">const</span> reqId = store.get(<span class="string">'reqId'</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'reqId&lt;&lt;&lt;'</span>, reqId);</span><br><span class="line">    res.status(<span class="number">200</span>).json(&#123;</span><br><span class="line">        message: <span class="string">'Testing response worked ðŸ˜„'</span>,</span><br><span class="line">        requestId: reqId</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.listen(<span class="string">'4000'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'listening on port 4000...'</span>)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>This code sets up a trivial Node.js API with a <code>test</code> endpoint that returns the captured request id of the current request.</p>
<p>To capture the request, we create an instance of the async local storage API as follows:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> asyncLocalStorage = <span class="keyword">new</span> AsyncLocalStorage();</span><br></pre></td></tr></table></figure>

<p>We then create our request middleware that will capture our HTTP request. Inside it, we use the <code>asyncLocalStorage.run()</code> method to set up our async store.</p>
<p>The first argument of the method is a store, which in our case is a javascript map, while the second is a callback and the last (not passed in our case), an optional list of arguments that are passed to the callback. The store is only accessible inside the callback or in async operations created by the callback.</p>
<p>The <code>asyncLocalStorage.getStore()</code> method returns the contents of the store object which in our case is a map. In our example, we generate a new request Id and set it in the map.</p>
<p>To use our middleware, we register it using the express <code>app.use()</code> syntax as follows. This makes the async local storage store available down our request pipeline.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.use(requestMiddleware);</span><br></pre></td></tr></table></figure>

<p>Since we have access to the store, we can simply fetch the request id from the store in the <code>/test</code> endpoint and log it as follows:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = asyncLocalStorage.getStore();</span><br><span class="line"><span class="keyword">const</span> reqId = store.get(<span class="string">'reqId'</span>);</span><br></pre></td></tr></table></figure>

<p>When you run this code, and make a request on a REST client you should get a response similar to this:</p>
<p><img src="/images/getting-started-with-async-local-storage/screenshot01.png" alt="Screenshot of REST Client"></p>
<p>You should also get the request id logged on the terminal.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>What I have shared, is a contrived example showing what is possible with the async local storage API. There is certainly a wider field for its application.</p>
<p>I conjecture that the order of problems that are currently solved by cls-hooked could be well solved by this API. <a rel="nofollow noopener" target="_blank" href="https://nodejs.org/api/async_hooks.html#async_hooks_class_asynclocalstorage">The official documentation </a> is probably the best place to start.</p>
<p>Happy coding ðŸ˜„</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/allan690" target="_blank" rel="noopener">Projects</a></li>
         
          <li><a href="/contact/">Contact</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Getting-Started"><span class="toc-number">2.</span> <span class="toc-text">Getting Started</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">3.</span> <span class="toc-text">Conclusion</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://allanmogusu.tk/2020/05/20/node/getting-started-with-async-local-storage/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://allanmogusu.tk/2020/05/20/node/getting-started-with-async-local-storage/&text=Getting Started With Async Local Storage API in Node.js" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://allanmogusu.tk/2020/05/20/node/getting-started-with-async-local-storage/&title=Getting Started With Async Local Storage API in Node.js" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://allanmogusu.tk/2020/05/20/node/getting-started-with-async-local-storage/&is_video=false&description=Getting Started With Async Local Storage API in Node.js" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Getting Started With Async Local Storage API in Node.js&body=Check out this article: https://allanmogusu.tk/2020/05/20/node/getting-started-with-async-local-storage/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://allanmogusu.tk/2020/05/20/node/getting-started-with-async-local-storage/&title=Getting Started With Async Local Storage API in Node.js" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://allanmogusu.tk/2020/05/20/node/getting-started-with-async-local-storage/&title=Getting Started With Async Local Storage API in Node.js" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://allanmogusu.tk/2020/05/20/node/getting-started-with-async-local-storage/&title=Getting Started With Async Local Storage API in Node.js" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://allanmogusu.tk/2020/05/20/node/getting-started-with-async-local-storage/&title=Getting Started With Async Local Storage API in Node.js" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://allanmogusu.tk/2020/05/20/node/getting-started-with-async-local-storage/&name=Getting Started With Async Local Storage API in Node.js&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://allanmogusu.tk/2020/05/20/node/getting-started-with-async-local-storage/&t=Getting Started With Async Local Storage API in Node.js" target="_blank" rel="noopener"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2021
    Allan Mogusu
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/allan690" target="_blank" rel="noopener">Projects</a></li>
         
          <li><a href="/contact/">Contact</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
